---
title: "module_completeness"
author: "Lasse Steffensen"
date: "2026-02-18"
output: html_document
---

--------------------------------------------------------------------------------
                                    Pre    
--------------------------------------------------------------------------------

```{r}

setwd("C:/Users/lasse/Desktop/wd/25/01_05/module_completeness")

library(tidyverse)
library(reshape2)
library(colorspace)
library(ggtext)
library(ggalluvial)
library(scales)
library(ggh4x)
library(tibble)
library(tidytext)
library(patchwork)
library(RColorBrewer)


# Annotation files
annotations <- read.csv("C:/Users/lasse/Desktop/wd/25/01_05/write_files/annotations_all.tsv", sep="\t", header=TRUE)

meso_annotations <- read.csv("C:/Users/lasse/Desktop/wd/25/01_05/write_files/meso_mags_annotations.tsv", sep="\t", header=TRUE)

thermo_annotations <- read.csv("C:/Users/lasse/Desktop/wd/25/01_05/write_files/thermo_mags_annotations.tsv", sep="\t", header=TRUE)


# Tax files
meso_tax <- read.csv("C:/Users/lasse/Desktop/wd/25/01_05/write_files/meso_mags_tax.tsv", sep="\t", header=TRUE)

thermo_tax <- read.csv("C:/Users/lasse/Desktop/wd/25/01_05/write_files/thermo_mags_tax.tsv", sep="\t", header=TRUE)


# Name map
name_map <- bind_rows(
  meso_tax %>% mutate(source = "meso"),
  thermo_tax %>% mutate(source = "thermo")
) %>%
  transmute(
    old = as.character(Genome),
    species = str_squish(species),
    genus   = str_squish(genus),
    family  = str_squish(family),
    new = case_when(
      !is.na(species) & species != "" ~ species,
      !is.na(genus)   & genus   != "" ~ paste0("g_", genus, " sp"),
      !is.na(family)  & family  != "" ~ paste0("f_", family, " sp"),
      TRUE ~ old
    ),
    source
  ) %>%
  arrange(old, desc(new != old), source) %>%
  distinct(old, .keep_all = TRUE) %>%
  select(old, new)


# Module file
modules <- read.csv("C:/Users/lasse/Desktop/wd/25/df/26/module_phase.tsv", sep="\t", header=TRUE)





```


Prepare dataframes for plotting
```{r}

# Concatenate files (Remove redundant variables and non-target modules)
meso_ann_tax <- meso_annotations %>%
  left_join(
    meso_tax %>% select(-rel_abun, -mean, -cov_frac), 
    by = "Genome") %>%
  left_join(modules, by = "module") %>%
  filter(!is.na(phase)) %>%
  left_join(name_map, by= c("Genome" = "old")) %>%
  mutate(sample = "meso")


thermo_ann_tax <- thermo_annotations %>%
  left_join(
    thermo_tax %>% select(-rel_abun, -mean, -cov_frac), 
    by = "Genome") %>%
  left_join(modules, by = "module") %>%
  filter(!is.na(phase)) %>%
  left_join(name_map, by= c("Genome" = "old")) %>%
  mutate(sample = "thermo")

joined_ann_tax <- bind_rows(meso_ann_tax, thermo_ann_tax)




```


Create tax-level rel abun labels
```{r}
### Phylum-level
phylum_abun_meso <- meso_tax %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum), !is.na(rel_abun)) %>%
  group_by(phylum) %>%
  summarise(
    phylum_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "meso")


phylum_abun_thermo <- thermo_tax %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum), !is.na(rel_abun)) %>%
  group_by(phylum) %>%
  summarise(
    phylum_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "thermo")

phylum_abun <- bind_rows(phylum_abun_meso, phylum_abun_thermo)


### Class-level
class_abun_meso <- meso_tax %>%
  mutate(class = na_if(class, "")) %>%
  filter(!is.na(class), !is.na(rel_abun)) %>%
  group_by(class) %>%
  summarise(
    class_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "meso")


class_abun_thermo <- thermo_tax %>%
  mutate(class = na_if(class, "")) %>%
  filter(!is.na(class), !is.na(rel_abun)) %>%
  group_by(class) %>%
  summarise(
    class_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "thermo")

class_abun <- bind_rows(class_abun_meso, class_abun_thermo)


### order-level
order_abun_meso <- meso_tax %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order), !is.na(rel_abun)) %>%
  group_by(order) %>%
  summarise(
    order_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "meso")


order_abun_thermo <- thermo_tax %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order), !is.na(rel_abun)) %>%
  group_by(order) %>%
  summarise(
    order_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "thermo")

order_abun <- bind_rows(order_abun_meso, order_abun_thermo)


### family-level
family_abun_meso <- meso_tax %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family), !is.na(rel_abun)) %>%
  group_by(family) %>%
  summarise(
    family_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "meso")


family_abun_thermo <- thermo_tax %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family), !is.na(rel_abun)) %>%
  group_by(family) %>%
  summarise(
    family_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "thermo")

family_abun <- bind_rows(family_abun_meso, family_abun_thermo)


### Genus-level
genus_abun_meso <- meso_tax %>%
  mutate(genus = na_if(genus, "")) %>%
  filter(!is.na(genus), !is.na(rel_abun)) %>%
  group_by(genus) %>%
  summarise(
    genus_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "meso")


genus_abun_thermo <- thermo_tax %>%
  mutate(genus = na_if(genus, "")) %>%
  filter(!is.na(genus), !is.na(rel_abun)) %>%
  group_by(genus) %>%
  summarise(
    genus_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "thermo")

genus_abun <- bind_rows(genus_abun_meso, genus_abun_thermo)


### Species-level
meso_ann_tax_unique <- meso_ann_tax %>%
  select(Genome, new) %>%
  distinct()

thermo_ann_tax_unique <- thermo_ann_tax %>%
  select(Genome, new) %>%
  distinct()


meso_tax <- meso_tax %>%
  left_join(meso_ann_tax_unique, by = "Genome")

thermo_tax <- thermo_tax %>%
  left_join(thermo_ann_tax_unique, by = "Genome")


new_abun_meso <- meso_tax %>%
  group_by(new) %>%
  summarise(
    new_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "meso")


new_abun_thermo <- thermo_tax %>%
  group_by(new) %>%
  summarise(
    new_r_abund = sum(rel_abun, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(sample = "thermo")

new_abun <- bind_rows(new_abun_meso, new_abun_thermo)


```



#####################################################################################







                         Higher taxonomic level analysis
                             (all taxa, no filter)








#####################################################################################


Phylum-level (except for methanogenesis)

Hydrolysis (phylum-level)
```{r}

###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################


# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "meso") %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

# collapse to genus x module
hyd_phylum0 <- hyd %>%
  mutate(Percent_steps_found = as.numeric(Percent_steps_found)) %>%
  group_by(Genome, phylum, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(phylum, module) %>%
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)






# Force-show all modules by completing the grid
hyd_phylum <- hyd_phylum0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    phylum,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_phylum <- hyd_phylum %>%
  group_by(phylum) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_phylum <- hyd_phylum %>%
  left_join(phylum_abun %>% filter(sample == "meso"), by = "phylum")

hyd_phylum <- hyd_phylum %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0, 
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

phylum_labels <- phylum_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", phylum_r_abund)) %>%
  semi_join(hyd_phylum %>% distinct(phylum), by = "phylum")



hydm <- ggplot(hyd_phylum, aes(x = module, y = phylum)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = phylum_labels,
    aes(x = -Inf, y = phylum, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = ifelse(n_genomes > 0, n_genomes, "")), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydm





###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "thermo") %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

hyd_phylum0 <- hyd %>%
  mutate(Percent_steps_found = as.numeric(Percent_steps_found)) %>%
  group_by(Genome, phylum, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(phylum, module) %>%
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)





# Force-show all modules by completing the grid
hyd_phylum <- hyd_phylum0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    phylum,
    module,
    fill = list(
      Percent_steps_found = 0, 
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_phylum <- hyd_phylum %>%
  group_by(phylum) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_phylum <- hyd_phylum %>%
  left_join(phylum_abun %>% filter(sample == "thermo"), by = "phylum")

hyd_phylum <- hyd_phylum %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

phylum_labels <- phylum_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", phylum_r_abund)) %>%
  semi_join(hyd_phylum %>% distinct(phylum), by = "phylum")



hydt <- ggplot(hyd_phylum, aes(x = module, y = phylum)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = phylum_labels,
    aes(x = -Inf, y = phylum, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = ifelse(n_genomes > 0, n_genomes, "")), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydt


hyd <- hydm | hydt 


ggsave(filename = "phylum/hydrolysis.png", plot = hyd,
       width = 10, height = 7, dpi = 300)



```

Acidogenesis (phylum-level)
```{r}

############################################################################################################
###                                             Meso                                                     ###
############################################################################################################


# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "meso") %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_phylum0 <- acid %>%
  group_by(Genome, phylum, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(phylum, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acid_phylum <- acid_phylum0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    phylum,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_phylum <- acid_phylum %>%
  group_by(phylum) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_phylum <- acid_phylum %>%
  left_join(phylum_abun %>% filter(sample == "meso"), by = "phylum")

acid_phylum <- acid_phylum %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

phylum_labels <- phylum_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", phylum_r_abund)) %>%
  semi_join(acid_phylum %>% distinct(phylum), by = "phylum")



acidm <- ggplot(acid_phylum, aes(x = module, y = phylum)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = phylum_labels,
    aes(x = -Inf, y = phylum, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "thermo") %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_phylum0 <- acid %>%
  group_by(Genome, phylum, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(phylum, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acid_phylum <- acid_phylum0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    phylum,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_phylum <- acid_phylum %>%
  group_by(phylum) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_phylum <- acid_phylum %>%
  left_join(phylum_abun %>% filter(sample == "thermo"), by = "phylum")

acid_phylum <- acid_phylum %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

phylum_labels <- phylum_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", phylum_r_abund)) %>%
  semi_join(acid_phylum %>% distinct(phylum), by = "phylum")



acidt <- ggplot(acid_phylum, aes(x = module, y = phylum)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = phylum_labels,
    aes(x = -Inf, y = phylum, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidt


acid <- acidm / acidt



ggsave(filename = "phylum/acidogenesis.png", plot = acid,
       width = 20, height = 15, dpi = 300)


```

Acetogenesis (phylum-level)
```{r}


###########################################################################################################
###                                            Meso                                                     ###
###########################################################################################################


# Filter only by phase and sample
acet <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "meso") %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum))

# Use module order from modules
module_order_acet <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to genus x module
acet_phylum0 <- acet %>%
  group_by(Genome, phylum, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(phylum, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acet_phylum <- acet_phylum0 %>%
  mutate(module = factor(module, levels = module_order_acet)) %>%
  complete(
    phylum,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acet_phylum <- acet_phylum %>%
  group_by(phylum) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acet_phylum <- acet_phylum %>%
  left_join(phylum_abun %>% filter(sample == "meso"), by = "phylum")

acet_phylum <- acet_phylum %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

phylum_labels <- phylum_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", phylum_r_abund)) %>%
  semi_join(acet_phylum %>% distinct(phylum), by = "phylum")



acetm <- ggplot(acet_phylum, aes(x = module, y = phylum)) +
  geom_tile(aes(alpha = alpha),
            fill = "palevioletred4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palevioletred4"))) +
  geom_text(
    data = phylum_labels,
    aes(x = -Inf, y = phylum, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acetm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
acet <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "thermo") %>%
  mutate(phylum = na_if(phylum, "")) %>%
  filter(!is.na(phylum))

# Use module order from modules
module_order_acet <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to genus x module
acet_phylum0 <- acet %>%
  group_by(Genome, phylum, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(phylum, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acet_phylum <- acet_phylum0 %>%
  mutate(module = factor(module, levels = module_order_acet)) %>%
  complete(
    phylum,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acet_phylum <- acet_phylum %>%
  group_by(phylum) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acet_phylum <- acet_phylum %>%
  left_join(phylum_abun %>% filter(sample == "thermo"), by = "phylum")

acet_phylum <- acet_phylum %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0, 
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

phylum_labels <- phylum_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", phylum_r_abund)) %>%
  semi_join(acet_phylum %>% distinct(phylum), by = "phylum")



acett <- ggplot(acet_phylum, aes(x = module, y = phylum)) +
  geom_tile(aes(alpha = alpha),
            fill = "palevioletred4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palevioletred4"))) +
  geom_text(
    data = phylum_labels,
    aes(x = -Inf, y = phylum, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acett


acet <- acetm | acett 


ggsave(filename = "phylum/acetogenesis.png", plot = acet,
       width = 16, height = 8, dpi = 300)



```

Methanogenesis (genus-level)
```{r}

############################################################################################################
###                                             Meso                                                     ###
############################################################################################################


# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Methanogenesis", sample == "meso") %>%
  mutate(genus = na_if(genus, "")) %>%
  filter(!is.na(genus))

# Use module order from modules
module_order_meth <- modules %>%
  filter(phase == "Methanogenesis") %>%
  pull(module)

# collapse to genus x module
m_genus0 <- m %>%
  group_by(Genome, genus, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(genus, module) %>%  
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
m_genus <- m_genus0 %>%
  mutate(module = factor(module, levels = module_order_meth)) %>%
  complete(
    genus,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_genus <- m_genus %>%
  group_by(genus) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
m_genus <- m_genus %>%
  left_join(genus_abun %>% filter(sample == "meso"), by = "genus")

m_genus <- m_genus %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

genus_labels <- genus_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", genus_r_abund)) %>%
  semi_join(m_genus %>% distinct(genus), by = "genus")



pm <- ggplot(m_genus, aes(x = module, y = genus)) +
  geom_tile(aes(alpha = alpha),
            fill = "mediumpurple4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "mediumpurple4"))) +
  geom_text(
    data = genus_labels,
    aes(x = -Inf, y = genus, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

pm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Methanogenesis", sample == "thermo") %>%
  mutate(genus = na_if(genus, "")) %>%
  filter(!is.na(genus))

# Use module order from modules
module_order_meth <- modules %>%
  filter(phase == "Methanogenesis") %>%
  pull(module)

# collapse to genus x module
m_genus0 <- m %>%
  group_by(Genome, genus, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(genus, module) %>%  
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)


# Force-show all modules by completing the grid
m_genus <- m_genus0 %>%
  mutate(module = factor(module, levels = module_order_meth)) %>%
  complete(
    genus,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_genus <- m_genus %>%
  group_by(genus) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
m_genus <- m_genus %>%
  left_join(genus_abun %>% filter(sample == "thermo"), by = "genus")

m_genus <- m_genus %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

genus_labels <- genus_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", genus_r_abund)) %>%
  semi_join(m_genus %>% distinct(genus), by = "genus")



pt <- ggplot(m_genus, aes(x = module, y = genus)) +
  geom_tile(aes(alpha = alpha),
            fill = "mediumpurple4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "mediumpurple4"))) +
  geom_text(
    data = genus_labels,
    aes(x = -Inf, y = genus, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

pt


p <- pm | pt 


ggsave(filename = "genus/methanogenesis.png", plot = p,
       width = 11, height = 6, dpi = 300)




```



Class-level 

Hydrolysis (class-level)
```{r}

###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################


# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "meso") %>%
  mutate(class = na_if(class, "")) %>%
  filter(!is.na(class))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

# collapse to genus x module
hyd_class0 <- hyd %>%
  group_by(Genome, class, module) %>% 
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(class, module) %>%               
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that phylum x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
hyd_class <- hyd_class0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    class,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_class <- hyd_class %>%
  group_by(class) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_class <- hyd_class %>%
  left_join(class_abun %>% filter(sample == "meso"), by = "class")

hyd_class <- hyd_class %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0, 
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

class_labels <- class_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", class_r_abund)) %>%
  semi_join(hyd_class %>% distinct(class), by = "class")



hydm <- ggplot(hyd_class, aes(x = module, y = class)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = class_labels,
    aes(x = -Inf, y = class, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydm





###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "thermo") %>%
  mutate(class = na_if(class, "")) %>%
  filter(!is.na(class))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

# collapse to genus x module
hyd_class0 <- hyd %>%
  group_by(Genome, class, module) %>%       
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(class, module) %>%                 
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that class x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
hyd_class <- hyd_class0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    class,
    module,
    fill = list(
      Percent_steps_found = 0, 
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_class <- hyd_class %>%
  group_by(class) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_class <- hyd_class %>%
  left_join(class_abun %>% filter(sample == "thermo"), by = "class")

hyd_class <- hyd_class %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

class_labels <- class_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", class_r_abund)) %>%
  semi_join(hyd_class %>% distinct(class), by = "class")



hydt <- ggplot(hyd_class, aes(x = module, y = class)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = class_labels,
    aes(x = -Inf, y = class, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydt


hyd <- hydm | hydt 


ggsave(filename = "class/hydrolysis.png", plot = hyd,
       width = 10, height = 7, dpi = 300)


```

Acidogenesis (class-level)
```{r}

############################################################################################################
###                                             Meso                                                     ###
############################################################################################################


# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "meso") %>%
  mutate(class = na_if(class, "")) %>%
  filter(!is.na(class))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_class0 <- acid %>%
  group_by(Genome, class, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(class, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that class x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acid_class <- acid_class0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    class,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_class <- acid_class %>%
  group_by(class) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_class <- acid_class %>%
  left_join(class_abun %>% filter(sample == "meso"), by = "class")

acid_class <- acid_class %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

class_labels <- class_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", class_r_abund)) %>%
  semi_join(acid_class %>% distinct(class), by = "class")



acidm <- ggplot(acid_class, aes(x = module, y = class)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = class_labels,
    aes(x = -Inf, y = class, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "thermo") %>%
  mutate(class = na_if(class, "")) %>%
  filter(!is.na(class))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_class0 <- acid %>%
  group_by(Genome, class, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(class, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that class x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acid_class <- acid_class0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    class,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_class <- acid_class %>%
  group_by(class) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_class <- acid_class %>%
  left_join(class_abun %>% filter(sample == "thermo"), by = "class")

acid_class <- acid_class %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

class_labels <- class_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", class_r_abund)) %>%
  semi_join(acid_class %>% distinct(class), by = "class")



acidt <- ggplot(acid_class, aes(x = module, y = class)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = class_labels,
    aes(x = -Inf, y = class, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidt


acid <- acidm / acidt 


ggsave(filename = "class/acidogenesis.png", plot = acid,
       width = 22, height = 17, dpi = 300)


```

Acetogenesis (class-level)
```{r}

############################################################################################################
###                                             Meso                                                     ###
############################################################################################################


# Filter only by phase and sample
acet <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "meso") %>%
  mutate(class = na_if(class, "")) %>%
  filter(!is.na(class))

# Use module order from modules
module_order_acet <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to genus x module
acet_class0 <- acet %>%
  group_by(Genome, class, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(class, module) %>% 
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that class x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acet_class <- acet_class0 %>%
  mutate(module = factor(module, levels = module_order_acet)) %>%
  complete(
    class,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

acet_class <- acet_class %>%
  group_by(class) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acet_class <- acet_class %>%
  left_join(class_abun %>% filter(sample == "meso"), by = "class")

acet_class <- acet_class %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

class_labels <- class_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", class_r_abund)) %>%
  semi_join(acet_class %>% distinct(class), by = "class")



acetm <- ggplot(acet_class, aes(x = module, y = class)) +
  geom_tile(aes(alpha = alpha),
            fill = "palevioletred4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palevioletred4"))) +
  geom_text(
    data = class_labels,
    aes(x = -Inf, y = class, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acetm


acet <- acetm | acett 


ggsave(filename = "class/acetogenesis.png", plot = acet,
       width = 16, height = 8, dpi = 300)



```



Order-level

Hydrolysis (order-level)
```{r}

###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################

# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "meso") %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

# collapse to genus x module
hyd_order0 <- hyd %>%
  mutate(Percent_steps_found = as.numeric(Percent_steps_found)) %>%
  group_by(Genome, order, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(order, module) %>%
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that order x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
hyd_order <- hyd_order0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    order,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_order <- hyd_order %>%
  group_by(order) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_order <- hyd_order %>%
  left_join(order_abun %>% filter(sample == "meso"), by = "order")

hyd_order <- hyd_order %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0, 
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

order_labels <- order_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", order_r_abund)) %>%
  semi_join(hyd_order %>% distinct(order), by = "order")

hydm <- ggplot(hyd_order, aes(x = module, y = order)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = order_labels,
    aes(x = -Inf, y = order, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = ifelse(n_genomes > 0, n_genomes, "")), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydm





###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "thermo") %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

hyd_order0 <- hyd %>%
  mutate(Percent_steps_found = as.numeric(Percent_steps_found)) %>%
  group_by(Genome, order, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(order, module) %>%
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that order x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
hyd_order <- hyd_order0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    order,
    module,
    fill = list(
      Percent_steps_found = 0, 
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_order <- hyd_order %>%
  group_by(order) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_order <- hyd_order %>%
  left_join(order_abun %>% filter(sample == "thermo"), by = "order")

hyd_order <- hyd_order %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

order_labels <- order_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", order_r_abund)) %>%
  semi_join(hyd_order %>% distinct(order), by = "order")

hydt <- ggplot(hyd_order, aes(x = module, y = order)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = order_labels,
    aes(x = -Inf, y = order, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = ifelse(n_genomes > 0, n_genomes, "")), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydt


hyd <- hydm | hydt 


ggsave(filename = "order/hydrolysis.png", plot = hyd,
       width = 10, height = 7, dpi = 300)



```

Acidogenesis (order-level)
```{r}
############################################################################################################
###                                             Meso                                                     ###
############################################################################################################


# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "meso") %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_order0 <- acid %>%
  group_by(Genome, order, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(order, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that order x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acid_order <- acid_order0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    order,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_order <- acid_order %>%
  group_by(order) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_order <- acid_order %>%
  left_join(order_abun %>% filter(sample == "meso"), by = "order")

acid_order <- acid_order %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

order_labels <- order_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", order_r_abund)) %>%
  semi_join(acid_order %>% distinct(order), by = "order")



acidm <- ggplot(acid_order, aes(x = module, y = order)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = order_labels,
    aes(x = -Inf, y = order, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "thermo") %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_order0 <- acid %>%
  group_by(Genome, order, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(order, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that order x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)



# Force-show all modules by completing the grid
acid_order <- acid_order0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    order,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_order <- acid_order %>%
  group_by(order) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_order <- acid_order %>%
  left_join(order_abun %>% filter(sample == "thermo"), by = "order")

acid_order <- acid_order %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

order_labels <- order_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", order_r_abund)) %>%
  semi_join(acid_order %>% distinct(order), by = "order")



acidt <- ggplot(acid_order, aes(x = module, y = order)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = order_labels,
    aes(x = -Inf, y = order, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidt

acid <- acidm / acidt



ggsave(filename = "order/acidogenesis.png", plot = acid,
       width = 20, height = 15, dpi = 300)


```

Acetogenesis (order-level)
```{r}

###########################################################################################################
###                                            Meso                                                     ###
###########################################################################################################

# Filter only by phase and sample
acet <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "meso") %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order))

# Use module order from modules
module_order_acet <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to genus x module
acet_order0 <- acet %>%
  group_by(Genome, order, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(order, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that order x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
acet_order <- acet_order0 %>%
  mutate(module = factor(module, levels = module_order_acet)) %>%
  complete(
    order,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

acet_order <- acet_order %>%
  group_by(order) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acet_order <- acet_order %>%
  left_join(order_abun %>% filter(sample == "meso"), by = "order")

acet_order <- acet_order %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

order_labels <- order_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", order_r_abund)) %>%
  semi_join(acet_order %>% distinct(order), by = "order")

acetm <- ggplot(acet_order, aes(x = module, y = order)) +
  geom_tile(aes(alpha = alpha),
            fill = "palevioletred4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palevioletred4"))) +
  geom_text(
    data = order_labels,
    aes(x = -Inf, y = order, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acetm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
acet <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "thermo") %>%
  mutate(order = na_if(order, "")) %>%
  filter(!is.na(order))

# Use module order from modules
module_order_acet <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to genus x module
acet_order0 <- acet %>%
  group_by(Genome, order, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(order, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that order x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
acet_order <- acet_order0 %>%
  mutate(module = factor(module, levels = module_order_acet)) %>%
  complete(
    order,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

acet_order <- acet_order %>%
  group_by(order) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acet_order <- acet_order %>%
  left_join(order_abun %>% filter(sample == "thermo"), by = "order")

acet_order <- acet_order %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

order_labels <- order_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", order_r_abund)) %>%
  semi_join(acet_order %>% distinct(order), by = "order")

acett <- ggplot(acet_order, aes(x = module, y = order)) +
  geom_tile(aes(alpha = alpha),
            fill = "palevioletred4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palevioletred4"))) +
  geom_text(
    data = order_labels,
    aes(x = -Inf, y = order, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acett


acet <- acetm | acett 


ggsave(filename = "order/acetogenesis.png", plot = acet,
       width = 16, height = 8, dpi = 300)



```



Family-level

Hydrolysis (family-level)
```{r}

###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################

# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "meso") %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

# collapse to genus x module
hyd_family0 <- hyd %>%
  mutate(Percent_steps_found = as.numeric(Percent_steps_found)) %>%
  group_by(Genome, family, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(family, module) %>%
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that family x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
hyd_family <- hyd_family0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    family,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_family <- hyd_family %>%
  group_by(family) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_family <- hyd_family %>%
  left_join(family_abun %>% filter(sample == "meso"), by = "family")

hyd_family <- hyd_family %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0, 
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

family_labels <- family_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", family_r_abund)) %>%
  semi_join(hyd_family %>% distinct(family), by = "family")

hydm <- ggplot(hyd_family, aes(x = module, y = family)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = family_labels,
    aes(x = -Inf, y = family, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = ifelse(n_genomes > 0, n_genomes, "")), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydm





###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "thermo") %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family))

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

hyd_family0 <- hyd %>%
  mutate(Percent_steps_found = as.numeric(Percent_steps_found)) %>%
  group_by(Genome, family, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(family, module) %>%
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that family x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
hyd_family <- hyd_family0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    family,
    module,
    fill = list(
      Percent_steps_found = 0, 
      n_genomes = 0
    )
  ) %>%
  ungroup()

hyd_family <- hyd_family %>%
  group_by(family) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
hyd_family <- hyd_family %>%
  left_join(family_abun %>% filter(sample == "thermo"), by = "family")

hyd_family <- hyd_family %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

family_labels <- family_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", family_r_abund)) %>%
  semi_join(hyd_family %>% distinct(family), by = "family")

hydt <- ggplot(hyd_family, aes(x = module, y = family)) +
  geom_tile(aes(alpha = alpha),
            fill = "navyblue", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "navyblue"))) +
  geom_text(
    data = family_labels,
    aes(x = -Inf, y = family, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = ifelse(n_genomes > 0, n_genomes, "")), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

hydt


hyd <- hydm | hydt 


ggsave(filename = "family/hydrolysis.png", plot = hyd,
       width = 10, height = 7, dpi = 300)



```

Acidogenesis (family-level)
```{r}

############################################################################################################
###                                             Meso                                                     ###
############################################################################################################

# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "meso") %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_family0 <- acid %>%
  group_by(Genome, family, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(family, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that family x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
acid_family <- acid_family0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    family,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_family <- acid_family %>%
  group_by(family) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_family <- acid_family %>%
  left_join(family_abun %>% filter(sample == "meso"), by = "family")

acid_family <- acid_family %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

family_labels <- family_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", family_r_abund)) %>%
  semi_join(acid_family %>% distinct(family), by = "family")

acidm <- ggplot(acid_family, aes(x = module, y = family)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = family_labels,
    aes(x = -Inf, y = family, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "thermo") %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family))

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to genus x module
acid_family0 <- acid %>%
  group_by(Genome, family, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(family, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that family x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
acid_family <- acid_family0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    family,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acid_family <- acid_family %>%
  group_by(family) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acid_family <- acid_family %>%
  left_join(family_abun %>% filter(sample == "thermo"), by = "family")

acid_family <- acid_family %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

family_labels <- family_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", family_r_abund)) %>%
  semi_join(acid_family %>% distinct(family), by = "family")

acidt <- ggplot(acid_family, aes(x = module, y = family)) +
  geom_tile(aes(alpha = alpha),
            fill = "palegreen4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palegreen4"))) +
  geom_text(
    data = family_labels,
    aes(x = -Inf, y = family, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acidt


acid <- acidm / acidt


ggsave(filename = "family/acidogenesis.png", plot = acid,
       width = 20, height = 15, dpi = 300)


```

Acetogenesis (family-level)
```{r}

###########################################################################################################
###                                            Meso                                                     ###
###########################################################################################################

# Filter only by phase and sample
acet <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "meso") %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family))

# Use module order from modules
module_order_acet <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to genus x module
acet_family0 <- acet %>%
  group_by(Genome, family, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(family, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that family x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
acet_family <- acet_family0 %>%
  mutate(module = factor(module, levels = module_order_acet)) %>%
  complete(
    family,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acet_family <- acet_family %>%
  group_by(family) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acet_family <- acet_family %>%
  left_join(family_abun %>% filter(sample == "meso"), by = "family")

acet_family <- acet_family %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0,
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

family_labels <- family_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", family_r_abund)) %>%
  semi_join(acet_family %>% distinct(family), by = "family")

acetm <- ggplot(acet_family, aes(x = module, y = family)) +
  geom_tile(aes(alpha = alpha),
            fill = "palevioletred4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palevioletred4"))) +
  geom_text(
    data = family_labels,
    aes(x = -Inf, y = family, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acetm





############################################################################################################
###                                             Thermo                                                   ###
############################################################################################################

# Filter only by phase and sample
acet <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "thermo") %>%
  mutate(family = na_if(family, "")) %>%
  filter(!is.na(family))

# Use module order from modules
module_order_acet <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to genus x module
acet_family0 <- acet %>%
  group_by(Genome, family, module) %>%              # <-- MUST include module here
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(family, module) %>%                      # <-- and here
  summarise(
  Percent_steps_found = max(p, na.rm = TRUE),
  # Count genomes in the highest completeness group for that family x module tile
  n_genomes = case_when(
    max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
    max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
    max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
    TRUE                        ~ 0
  ),
  .groups = "drop"
)

# Force-show all modules by completing the grid
acet_family <- acet_family0 %>%
  mutate(module = factor(module, levels = module_order_acet)) %>%
  complete(
    family,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

acet_family <- acet_family %>%
  group_by(family) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
acet_family <- acet_family %>%
  left_join(family_abun %>% filter(sample == "thermo"), by = "family")

acet_family <- acet_family %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found)        ~ 0,
      Percent_steps_found < 50          ~ 0, 
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    )
  )

family_labels <- family_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", family_r_abund)) %>%
  semi_join(acet_family %>% distinct(family), by = "family")

acett <- ggplot(acet_family, aes(x = module, y = family)) +
  geom_tile(aes(alpha = alpha),
            fill = "palevioletred4", color = NA, width = 0.9, height = 0.9) +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "palevioletred4"))) +
  geom_text(
    data = family_labels,
    aes(x = -Inf, y = family, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )

acett


acet <- acetm | acett 


ggsave(filename = "family/acetogenesis.png", plot = acet,
       width = 16, height = 8, dpi = 300)



```



#####################################################################################







                         Lower taxonomic level analysis
                         (top X contributing taxa only)








#####################################################################################

Hydrolysis
```{r}


###########################################################################################################
###                 Top-15 per sample (meso + thermo) + shared colours for shared species               ###
###########################################################################################################

# Determine which new are eligible per sample (>=1 Acidogenesis module at 100% in that sample)
hyd <- joined_ann_tax %>%
  filter(phase == "Hydrolysis") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  group_by(sample, Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop")

eligible_new_by_sample <- hyd %>%
  group_by(sample, new) %>%
  summarise(has100 = any(p >= 100, na.rm = TRUE), .groups = "drop") %>%
  filter(has100)

# Top 15 within EACH sample (based on that sample's abundance table)
top_new_meso <- new_abun %>%
  filter(sample == "meso") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "meso"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

top_new_thermo <- new_abun %>%
  filter(sample == "thermo") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "thermo"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

# Shared species among the two top-15 lists
shared_new <- intersect(top_new_meso, top_new_thermo)

# Shared colours only (everything else will be grey)
pal_shared <- if (length(shared_new) == 0) character(0) else
  colorRampPalette(brewer.pal(12, "Paired"))(length(shared_new))

new_cols <- c(
  setNames(pal_shared, shared_new),
  Unique = "grey75"
)


###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "meso") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_meso)

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join new abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "meso"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce meso y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_meso))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_meso))

pm <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )


###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Hydrolysis", sample == "thermo") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_thermo)

# Use module order from modules
module_order_hyd <- modules %>%
  filter(phase == "Hydrolysis") %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_hyd)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "thermo"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce thermo y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_thermo))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_thermo))

pt <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )


p <- pm | pt


ggsave(filename = "species/species_hydrolysis.png", plot = p,
       width = 14, height = 9, dpi = 300, limitsize = FALSE)




```


Acidogenesis
```{r}


###########################################################################################################
###                 Top-15 per sample (meso + thermo) + shared colours for shared species                 ###
###########################################################################################################

# Determine which new are eligible per sample (>=1 Acidogenesis module at 100% in that sample)
acid <- joined_ann_tax %>%
  filter(phase == "Acidogenesis") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  group_by(sample, Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop")

eligible_new_by_sample <- acid %>%
  group_by(sample, new) %>%
  summarise(has100 = any(p >= 100, na.rm = TRUE), .groups = "drop") %>%
  filter(has100)

# Top 15 within EACH sample (based on that sample's abundance table)
top_new_meso <- new_abun %>%
  filter(sample == "meso") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "meso"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

top_new_thermo <- new_abun %>%
  filter(sample == "thermo") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "thermo"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

# Shared species among the two top-15 lists
shared_new <- intersect(top_new_meso, top_new_thermo)

# Shared colours only (everything else will be grey)
pal_shared <- if (length(shared_new) == 0) character(0) else
  colorRampPalette(brewer.pal(12, "Paired"))(length(shared_new))

new_cols <- c(
  setNames(pal_shared, shared_new),
  Unique = "grey75"
)


###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "meso") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_meso)

# Use module order from modules
module_order_acid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join new abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "meso"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce meso y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_meso))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_meso))

pm <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )


###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Acidogenesis", sample == "thermo") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_thermo)

# Use module order from modules
module_orderacid <- modules %>%
  filter(phase == "Acidogenesis") %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_acid)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "thermo"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce thermo y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_thermo))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_thermo))

pt <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )


p <- pm / pt


ggsave(filename = "species/species_acidogenesis.png", plot = p,
       width = 30, height = 23, dpi = 300, limitsize = FALSE)




```


Acetogenesis (incl. transporters)
```{r}


###########################################################################################################
###                 Top-15 per sample (meso + thermo) + shared colours for shared species                 ###
###########################################################################################################

# Determine which new are eligible per sample (>=1 Acetgenesis module at 100% in that sample)
acid <- joined_ann_tax %>%
  filter(phase == "Acetogenesis") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  group_by(sample, Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop")

eligible_new_by_sample <- acid %>%
  group_by(sample, new) %>%
  summarise(has100 = any(p >= 100, na.rm = TRUE), .groups = "drop") %>%
  filter(has100)

# Top 15 within EACH sample (based on that sample's abundance table)
top_new_meso <- new_abun %>%
  filter(sample == "meso") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "meso"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

top_new_thermo <- new_abun %>%
  filter(sample == "thermo") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "thermo"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

# Shared species among the two top-15 lists
shared_new <- intersect(top_new_meso, top_new_thermo)

# Shared colours only (everything else will be grey)
pal_shared <- if (length(shared_new) == 0) character(0) else
  colorRampPalette(brewer.pal(12, "Paired"))(length(shared_new))

new_cols <- c(
  setNames(pal_shared, shared_new),
  Unique = "grey75"
)


###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "meso") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_meso)

# Use module order from modules
module_order_meth <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_meth)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join new abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "meso"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce meso y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_meso))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_meso))

pm <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )


###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "thermo") %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_thermo)

# Use module order from modules
module_order_meth <- modules %>%
  filter(phase == "Acetogenesis") %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_meth)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "thermo"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce thermo y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_thermo))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_thermo))

pt <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  )


p <- pm | pt


ggsave(filename = "species/species_acetogenesis_incl_transporters.png", plot = p,
       width = 15, height = 7, dpi = 300, limitsize = FALSE)



```


Acetogenesis (excl. transporters)
```{r}


###########################################################################################################
###                 Top-15 per sample (meso + thermo) + shared colours for shared species                 ###
###########################################################################################################

exclude_modules <- c("Formate transporter", "Formate degradation", "Acetate transporter")


# Determine which new are eligible per sample (>=1 Acetgenesis module at 100% in that sample)
acet <- joined_ann_tax %>%
  filter(
    phase == "Acetogenesis",
    !module %in% c("Formate transporter", "Formate degradation", "Acetate transporter")) %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  group_by(sample, Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop")

eligible_new_by_sample <- acet %>%
  group_by(sample, new) %>%
  summarise(has100 = any(p >= 100, na.rm = TRUE), .groups = "drop") %>%
  filter(has100)

# Top 15 within EACH sample (based on that sample's abundance table)
top_new_meso <- new_abun %>%
  filter(sample == "meso") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "meso"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

top_new_thermo <- new_abun %>%
  filter(sample == "thermo") %>%
  semi_join(eligible_new_by_sample %>% filter(sample == "thermo"), by = c("sample", "new")) %>%
  arrange(desc(new_r_abund)) %>%
  slice_head(n = 15) %>%
  pull(new)

# Shared species among the two top-15 lists
shared_new <- intersect(top_new_meso, top_new_thermo)

# Shared colours only (everything else will be grey)
pal_shared <- if (length(shared_new) == 0) character(0) else
  colorRampPalette(brewer.pal(12, "Paired"))(length(shared_new))

new_cols <- c(
  setNames(pal_shared, shared_new),
  Unique = "grey75"
)


###########################################################################################################
###                                             Meso                                                    ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "meso",
    !module %in% exclude_modules) %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_meso)

# Use module order from modules
module_order_meth <- modules %>%
  filter(phase == "Acetogenesis",
    !module %in% exclude_modules) %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_meth)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join new abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "meso"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "meso") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce meso y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_meso))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_meso))

pm <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -0.35),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  ) +
  labs(title = "Mesophilic")


###########################################################################################################
###                                             Thermo                                                  ###
###########################################################################################################

# Filter only by phase and sample
m <- joined_ann_tax %>%
  filter(phase == "Acetogenesis", sample == "thermo",
    !module %in% exclude_modules) %>%
  mutate(new = na_if(new, "")) %>%
  filter(!is.na(new)) %>%
  filter(new %in% top_new_thermo)

# Use module order from modules
module_order_meth <- modules %>%
  filter(phase == "Acetogenesis",
    !module %in% exclude_modules) %>%
  pull(module)

# collapse to new x module
m_new0 <- m %>%
  group_by(Genome, new, module) %>%
  summarise(p = max(Percent_steps_found, na.rm = TRUE), .groups = "drop") %>%
  group_by(new, module) %>%
  summarise(
    Percent_steps_found = max(p, na.rm = TRUE),
    # Count genomes in the highest completeness group for that phylum x module tile
    n_genomes = case_when(
      max(p, na.rm = TRUE) >= 100 ~ n_distinct(Genome[p >= 100]),
      max(p, na.rm = TRUE) >=  75 ~ n_distinct(Genome[p >=  75 & p < 100]),
      max(p, na.rm = TRUE) >=  50 ~ n_distinct(Genome[p >=  50 & p <  75]),
      TRUE                        ~ 0
    ),
    .groups = "drop"
  )

# Force-show all modules by completing the grid
m_new <- m_new0 %>%
  mutate(module = factor(module, levels = module_order_meth)) %>%
  complete(
    new,
    module,
    fill = list(
      Percent_steps_found = 0,  # empty = 0% completeness (will be invisible with alpha mapping below)
      n_genomes = 0
    )
  ) %>%
  ungroup()

m_new <- m_new %>%
  group_by(new) %>%
  filter(any(Percent_steps_found >= 50, na.rm = TRUE)) %>%
  ungroup()

# Join genus abundance
m_new <- m_new %>%
  left_join(new_abun %>% filter(sample == "thermo"), by = "new")

m_new <- m_new %>%
  mutate(
    alpha = case_when(
      is.na(Percent_steps_found) ~ 0,
      Percent_steps_found < 50   ~ 0,  # hide <50% (set e.g. 0.05 if you want faint tiles)
      TRUE ~ scales::rescale(Percent_steps_found, from = c(50, 100), to = c(0.15, 1))
    ),
    fill_key = ifelse(new %in% shared_new, as.character(new), "Unique")
  )

new_labels <- new_abun %>%
  filter(sample == "thermo") %>%
  mutate(abun_lab = sprintf("%.1f%%", new_r_abund)) %>%
  semi_join(m_new %>% distinct(new), by = "new")

# Enforce thermo y order (top->bottom)
m_new <- m_new %>%
  mutate(new = factor(new, levels = top_new_thermo))

new_labels <- new_labels %>%
  mutate(new = factor(new, levels = top_new_thermo))

pt <- ggplot(m_new, aes(x = module, y = new)) +
  geom_tile(aes(fill = fill_key, alpha = alpha),
            color = NA, width = 0.9, height = 0.9) +
  scale_fill_manual(values = new_cols, guide = "none") +
  scale_alpha(
    name   = "Module\ncompleteness",
    limits = c(0, 1),
    breaks = scales::rescale(c(50, 75, 100), from = c(50, 100), to = c(0.15, 1)),
    labels = c("50%", "75%", "100%"),
    range  = c(0, 1)
  ) +
  guides(alpha = guide_legend(override.aes = list(fill = "grey50"))) +
  geom_text(
    data = new_labels,
    aes(x = -Inf, y = new, label = abun_lab),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3,
    colour = "black"
  ) +
  geom_text(aes(label = n_genomes), colour = "white", size = 3) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10),
    axis.text.y = element_text(size = 10, hjust = -1.5),
    axis.ticks  = element_line(color = "black"),
    axis.title  = element_blank(),
    legend.position = "right",
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 60)
  ) +
  labs(title = "Thermophilic")


p <- pm | pt


ggsave(filename = "species/species_acetogenesis_excl_transporters.png", plot = p,
       width = 15, height = 7, dpi = 300, limitsize = FALSE)




```


Glimpse syntrophic butyrate- and propionate deg. and SAO
```{r}
# Syntrophic butyrate degradation
meso_syn_buty <- meso_ann_tax %>%
  filter(module == "Syntrophic butyrate degradation, butyrate => acetyl-CoA")

thermo_syn_buty <- thermo_ann_tax %>%
  filter(module == "Syntrophic butyrate degradation, butyrate => acetyl-CoA")


# Syntrophic propionate degradation
meso_syn_prop <- meso_ann_tax %>%
  filter(module == "Syntrophic propionate degradation, propionate => acetate")

thermo_syn_prop <- thermo_ann_tax %>%
  filter(module == "Syntrophic propionate degradation, propionate => acetate")


# Wood-Ljungdahl
meso_wl <- meso_ann_tax %>%
  filter(module == "Reductive acetyl-CoA pathway (Wood-Ljungdahl pathway)")

thermo_wl <- thermo_ann_tax %>%
  filter(module == "Reductive acetyl-CoA pathway (Wood-Ljungdahl pathway)")


# SAO
sao <- c("Reversed WL pathway, acetate => CO2", "WLP-GCS pathway, acetate => CO2")

meso_sao <- meso_ann_tax %>%
  filter(module %in% sao)

thermo_sao <- thermo_ann_tax %>%
  filter(module %in% sao)


```

```{r}

```

```{r}

```

```{r}

```
